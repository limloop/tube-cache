{% extends "base.html" %}

{% block title %}–í—Å–µ –≤–∏–¥–µ–æ - Video Server{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="bi bi-collection-play"></i> –í—Å–µ –≤–∏–¥–µ–æ
        <span class="badge bg-secondary">{{ total_videos }}</span>
    </h1>
    
    <div>
        <a href="/" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –≤–∏–¥–µ–æ
        </a>
    </div>
</div>

<!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
<div class="card mb-4 shadow">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" class="form-control" name="search" 
                           placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∞–≤—Ç–æ—Ä—É..." 
                           value="{{ search }}">
                </div>
            </div>
            <div class="col-md-4">
                <select class="form-select" name="status">
                    <option value="ready" {% if status == 'ready' %}selected{% endif %}>
                        ‚úÖ –¢–æ–ª—å–∫–æ –≥–æ—Ç–æ–≤—ã–µ
                    </option>
                    <option value="all" {% if status == 'all' %}selected{% endif %}>
                        üìã –í—Å–µ —Å—Ç–∞—Ç—É—Å—ã
                    </option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-outline-primary w-100">
                    <i class="bi bi-funnel"></i> –§–∏–ª—å—Ç—Ä
                </button>
            </div>
        </form>
    </div>
</div>

{% if videos %}
<!-- –¢–∞–±–ª–∏—Ü–∞ –≤–∏–¥–µ–æ -->
<div class="card shadow">
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–ê–≤—Ç–æ—Ä</th>
                    <th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th>
                    <th>–†–∞–∑–º–µ—Ä</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for video in videos %}
                <tr>
                    <td>
                        <strong>{{ video.title|truncate(40) if video.title else video.source_url }}</strong>
                        <br>
                        <small class="text-muted">{{ video.short_hash }}</small>
                        {% if not video.title %}
                        <br>
                        <small class="text-muted"><i>–ù–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è</i></small>
                        {% endif %}
                    </td>
                    <td>
                        {{ video.uploader|truncate(20) if video.uploader else '<small class="text-muted"><i>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</i></small>'|safe }}
                    </td>
                    <td>
                        {{ video.duration_str if video.duration_str else '<span class="text-muted">‚Äî</span>'|safe }}
                    </td>
                    <td>
                        {{ video.file_size if video.file_size else '<span class="text-muted">‚Äî</span>'|safe }}
                    </td>
                    <td>
                        <span class="badge {% if video.status == 'ready' %}bg-success
                                          {% elif video.status == 'downloading' %}bg-info
                                          {% elif video.status == 'pending' %}bg-warning
                                          {% elif video.status == 'failed' %}bg-danger
                                          {% elif video.status == 'deleted' %}bg-secondary
                                          {% else %}bg-dark{% endif %} status-badge">
                            {{ video.status_text }}
                        </span>
                    </td>
                    <td>
                        {% if video.status == 'ready' %}
                        <a href="/video/{{ video.hash }}" class="btn btn-sm btn-success" title="–°–º–æ—Ç—Ä–µ—Ç—å">
                            <i class="bi bi-play-fill"></i>
                        </a>
                        <a href="/stream/{{ video.hash }}" class="btn btn-sm btn-outline-primary" title="–°—Ç—Ä–∏–º–∏–Ω–≥" target="_blank">
                            <i class="bi bi-cast"></i>
                        </a>
                        {% endif %}
                        
                        <!-- –ö–Ω–æ–ø–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ–≥–¥–∞ –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–µ—à) -->
                        <a href="/info/{{ video.hash }}" class="btn btn-sm btn-outline-info" title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è">
                            <i class="bi bi-info-circle"></i>
                        </a>
                        
                        <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è failed/deleted –∏–ª–∏ –µ—Å–ª–∏ –Ω–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö -->
                        {% if video.status in ['failed', 'deleted'] or not video.title %}
                        <form action="/download" method="post" style="display: inline;">
                            <input type="hidden" name="url" value="{{ video.source_url }}">
                            <button type="submit" class="btn btn-sm btn-warning" title="–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </form>
                        {% endif %}
                        
                        <!-- –î–ª—è pending/downloading –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –≤ –æ—á–µ—Ä–µ–¥–∏ -->
                        {% if video.status in ['pending', 'downloading'] %}
                        <span class="badge bg-secondary" title="–í –ø—Ä–æ—Ü–µ—Å—Å–µ –∑–∞–≥—Ä—É–∑–∫–∏">
                            <i class="bi bi-hourglass-split"></i>
                        </span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
{% if total_pages > 1 %}
<nav class="mt-4">
    <ul class="pagination justify-content-center">
        <li class="page-item {% if not has_prev %}disabled{% endif %}">
            <a class="page-link" href="?page={{ prev_page }}&search={{ search }}&status={{ status }}">
                <i class="bi bi-chevron-left"></i>
            </a>
        </li>
        
        {% for p in range(1, total_pages + 1) %}
        <li class="page-item {% if p == page %}active{% endif %}">
            <a class="page-link" href="?page={{ p }}&search={{ search }}&status={{ status }}">
                {{ p }}
            </a>
        </li>
        {% endfor %}
        
        <li class="page-item {% if not has_next %}disabled{% endif %}">
            <a class="page-link" href="?page={{ next_page }}&search={{ search }}&status={{ status }}">
                <i class="bi bi-chevron-right"></i>
            </a>
        </li>
    </ul>
</nav>
{% endif %}

{% else %}
<!-- –ù–µ—Ç –≤–∏–¥–µ–æ -->
<div class="text-center py-5">
    <div class="display-1 text-muted">
        <i class="bi bi-film"></i>
    </div>
    <h3 class="mt-3">–í–∏–¥–µ–æ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
    <p class="text-muted">
        {% if search %}
        –ü–æ –∑–∞–ø—Ä–æ—Å—É "{{ search }}" –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
        {% else %}
        –ï—â–µ –Ω–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ –≤–∏–¥–µ–æ!
        {% endif %}
    </p>
    <a href="/" class="btn btn-primary btn-lg mt-3">
        <i class="bi bi-cloud-download"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ
    </a>
</div>
{% endif %}
{% endblock %}